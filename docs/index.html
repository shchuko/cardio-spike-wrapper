<!DOCTYPE html>
<html lang="en">
<body>
<h1>API usage example</h1>
<h2>Analyze data from CSV file</h2>
<form id="formElem" onsubmit="return false">
    <input id="fileinput" type="file" name="fileupload"/>
    <button id="uploadbtn" disabled="disabled">Analyze Data</button>
</form>

<ul id="messages">
</ul>

<div id="downloadlink">
</div>

<div id="statslist">
</div>

<div id="picture">
</div>

<script>
    let ws = null
    let status = 'done'
    const downloadlink = document.getElementById('downloadlink')
    const messages = document.getElementById('messages')
    const statslist = document.getElementById('statslist')
    const picture = document.getElementById('picture')
    const uploadbtn = document.getElementById('uploadbtn')
    const fileinput = document.getElementById('fileinput')
    const funcs = [process_status, process_png, process_stats, process_csv]
    let func_no = 0

    uploadbtn.disabled = ""

    function connectWs(fileBlob) {
        viewMsg('connecting...')
        status = 'connection'

        ws = new WebSocket(`wss://cardio-spike-alvani.herokuapp.com/ws`)

        ws.onopen = function () {
            viewMsg('connected...')
            ws.send(fileBlob)
            viewMsg('data is sent...')
            status = 'waiting response'
        }

        ws.onmessage = async function (event) {
            await funcs[func_no](event.data)
        }

        ws.onerror = function () {
            if (status === 'connection') {
                viewMsg('connect failed')
                uploadbtn.disabled = ""
                func_no = 0
            } else if (status === 'waiting response') {
                viewMsg('server disconnected')
                uploadbtn.disabled = ""
                func_no = 0
            }
        }

        ws.onclose = function () {
            if (status === 'waiting response') {
                viewMsg('server disconnected')
                uploadbtn.disabled = ""
            }
        }
    }

    function viewMsg(msg) {
        var message = document.createElement('li')
        var content = document.createTextNode(msg)
        message.appendChild(content)
        messages.appendChild(message)
    }

    uploadbtn.onclick = async () => {
        messages.innerHTML = ''
        downloadlink.innerHTML = ''
        statslist.innerHTML = ''
        picture.innerHTML = ''
        uploadbtn.disabled = "disabled"
        func_no = 0

        connectWs(fileinput.files[0])
    }

    async function process_status(data) {
        const json = JSON.parse(data)
        viewMsg('processing done, status: ' + json.status)

        if (json.status === 'success') {
            func_no++
        } else {
            func_no = 0
            uploadbtn.disabled = ""
            status = 'done'
            ws.close()
        }
    }

    async function process_png(data) {
        const blob = new Blob([data], {type: "image/png"});
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.src = url;
        picture.appendChild(img)
        func_no++
    }

    async function process_stats(data) {
        const json = JSON.parse(data)
        var content = document.createTextNode(JSON.stringify(json))
        statslist.appendChild(content)
        func_no++
    }

    async function process_csv(data) {
        const blob = new Blob([data], {type: 'text/plain'})

        const link = document.createElement('a')
        link.download = 'results.csv'
        link.href = URL.createObjectURL(blob)
        const linkText = document.createTextNode(link.download)
        link.appendChild(linkText)

        downloadlink.appendChild(link)
        func_no = 0
        uploadbtn.disabled = ""
        status = 'done'
        ws.close()
    }

</script>
</body>
</html>