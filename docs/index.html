<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Health Analyzer</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
<main>
    <h1 class="page-title">Health Analyzer</h1>
    <section class="upload__wrapper">
        <h2>Загрузка CSV файла</h2>
        <form class="upload__form" id="formElem" onsubmit="return false">
            <input class="upload__input" id="fileinput" type="file" name="fileupload" onchange="changeInput()"/>
            <label for="fileinput" class="upload__label">
                <span class="upload__text">Выберите файл</span>
            </label>
            <button class="upload__button" id="uploadbtn" disabled="disabled">Анализировать данные</button>
        </form>
    </section>
    <section class="analyze__wrapper">
        <h2 class="analyze__title">Анализ данных из CSV</h2>

        <div class="analyze-messages">
            <ul class="analyze-messages__list" id="messages">
            </ul>
        </div>

        <div class="download" id="downloadlink"></div>

        <div class="statistic" id="statslist"></div>

        <div class="picture" id="picture"></div>
    </section>
</main>


<script>
    function changeInput() {
        const input = document.querySelector(".upload__text");
        input.innerHTML = "Файл выбран";
    }
    const linkelem = document.getElementById('downloadlink')
    let ws = null
    let status = 'done'
    const messages = document.getElementById('messages')
    const statslist = document.getElementById('statslist')
    const picture = document.getElementById('picture')
    const uploadbtn = document.getElementById('uploadbtn')
    const fileinput = document.getElementById('fileinput')
    const funcs = [process_status, process_png, process_stats, process_csv]
    let func_no = 0

    uploadbtn.disabled = ""

    function connectWs(fileBlob) {
        viewMsg('connecting...')
        status = 'connection'

        ws = new WebSocket(`wss://cardio-spike-alvani.herokuapp.com/ws`)

        ws.onopen = function () {
            viewMsg('connected...')
            ws.send(fileBlob)
            viewMsg('data is sent...')
            status = 'waiting response'
        }

        ws.onmessage = async function (event) {
            await funcs[func_no](event.data)
        }

        ws.onerror = function () {
            if (status === 'connection') {
                viewMsg('connect failed')
                uploadbtn.disabled = ""
                func_no = 0
            } else if (status === 'waiting response') {
                viewMsg('server disconnected')
                uploadbtn.disabled = ""
                func_no = 0
            }
        }

        ws.onclose = function () {
            if (status === 'waiting response') {
                viewMsg('server disconnected')
                uploadbtn.disabled = ""
            }
        }
    }

    function viewMsg(msg) {
        let message = document.createElement('li');
        message.classList.add("analyze-messages__item");
        let content = document.createTextNode(msg)
        message.appendChild(content)
        messages.appendChild(message)
    }

    uploadbtn.onclick = async () => {
        messages.innerHTML = ''
        downloadlink.innerHTML = ''
        statslist.innerHTML = ''
        picture.innerHTML = ''
        uploadbtn.disabled = "disabled"
        func_no = 0

        connectWs(fileinput.files[0])
    }

    async function process_status(data) {
        const json = JSON.parse(data)
        viewMsg('processing done, status: ' + json.status)

        if (json.status === 'success') {
            func_no++
        } else {
            func_no = 0
            uploadbtn.disabled = ""
            status = 'done'
            ws.close()
        }
    }

    async function process_png(data) {
        const blob = new Blob([data], {type: "image/png"});
        const url = URL.createObjectURL(blob);
        const img = new Image(1200);
        img.src = url;
        //picture.appendChild(img);
        picture.style.backgroundImage = `url(${img.src})`

        func_no++
    }

    async function process_stats(data) {
        const title = document.createElement("h2");
        const content = document.createElement("div");
        title.innerText = "Статистика";
        const statistic = document.querySelector(".statistic");
        statistic.appendChild(title);
        statistic.appendChild(content);
        const json = JSON.parse(data);
        const arr = Object.values(json)[0];
        for (let obj in arr) {
            const ul = document.createElement("ul");
            content.appendChild(ul);
            for (let key in arr[obj]) {
                if (key === "part_size_factor") {
                    continue;
                }
                const li = document.createElement("li");
                ul.appendChild(li);
                li.innerText = `${key}: ${arr[obj][key]}`;
            }
        }
        func_no++
    }

    async function process_csv(data) {
        const downloadTitle = document.createElement("h2");
        downloadTitle.classList.add("download__title");
        const downloadSection = document.querySelector(".download");
        downloadSection.appendChild(downloadTitle);
        downloadTitle.innerText = "Скачайте файл с результатом";
        const blob = new Blob([data], {type: 'text/plain'});
        const link = document.createElement('a');
        link.classList.add("download__link");
        link.download = 'results.csv'
        link.href = URL.createObjectURL(blob)
        const linkText = document.createTextNode(link.download)
        link.appendChild(linkText)
        linkelem.appendChild(link)
        func_no = 0
        uploadbtn.disabled = ""
        status = 'done'
        ws.close()
    }

</script>
</body>
</html>